%% Define vehicle
R = 0.1; %Wheel radius [m]
L = 0.5; %Wheel base [m]
dd = DifferentialDrive(R,L);


%% Simulation parameters

sampleTime = 0.1;
tVec = 0:sampleTime:1883;

initPose = [12.3658274942841; 115.3136770771249;  deg2rad(0)];
pose = zeros (3, numel(tVec));
pose(:,1) = initPose;

%Define waypoints
waypoints = [
12.3658274942841, 115.3136770771249;
6.5848369958941, 114.4465285023664;
6.5848369958941, 121.6727666253539;
11.4986789195256, 122.8289647250319;
12.4792599783802, 127.1025230420972;
17.9060158311492, 131.9263060223363;
25.1416903015079, 135.0919136031182;
32.3773647718665, 136.4486025663104;
37.8041206246355, 136.4486025663104;
42.3264171686096, 135.996372911913;
49.5620916389683, 135.2426568212507;
55.4410771461347, 133.8859678580584;
59.5111440357114, 132.5292788948662;
64.3349270159505, 131.0218467135415;
69.0079667780571, 128.006982350892;
70.9212190751032, 129.5250828812159;
68.3355413645332, 131.9709942290523;
65, 135;
61.9062886787916, 136.5134010178915;
55.197503267583, 138.6098964588942;
47.160937410406, 138.7496628216277;
43.2298921426689, 137.2298199427576;
45.5832153002318, 138.432629556623;
47.5704659666182, 135.6086417675476;
49.4008284225004, 131.8956207856151;
46.0538799317444, 131.5818443646068;
43.7005567741815, 133.464502890657;
45.3582909377061, 131.4612307105581;
44.6346090134123, 130.898366991663;
40.8955857378945, 133.6724810347892;
43.388267921573, 130.4561169268168;
42.1419268297337, 128.6469121160823;
38.9255627217614, 132.7879809050968;
41.6594722135379, 127.9634347431382;
40.6543584297965, 125.2697298027113;
43.8305179864192, 123.0584794784803;
47.0468820943916, 121.4502974244941;
54.8867696075743, 119.6812971651093;
60.7968386559735, 119.3596607543121;
65.6615893692818, 120.1637517813052;
68.1140670016107, 120.4451836407528;
72.4179463384547, 120.310379808176;
71.1045466993176, 122.9371790864502;
68.4206430889069, 125.4497697004517;
63.4525661930405, 128.4191949715442;
64.1949225108137, 126.1350216860884;
63.6238791894497, 123.4511180756778;
62.1391665539034, 121.5095707830403;
58.4273849650377, 120.8243187974036;
55.7434813546271, 121.8521967758587;
53.5164124013076, 123.907952732769;
52.4314300907161, 126.3063346824976;
52.7740560835345, 129.0473426250446;
54.8298120404447, 130.9317855855457;
57.9705503079465, 130.3036379320453;
61.2254972397211, 129.2757599535902;
62.0249578896306, 131.4457245747732;
66.3077827998603, 129.5041772821358;
70.8391804225141, 126.0132080017416;
75, 120;
79.4812308651032, 120.8421450319956;
85.5023315833005, 122.3297110917856;
92.3734700499493, 121.0546544691085;
97.3320235825824, 119.0712330560552;
102.0118863736805, 122.1100142147026;
107.2281549806979, 125.3578795737889;
114.8065074852327, 127.2278626593235;
116.5780704083707, 130.0820473688236;
121.2038180410089, 132.0504506167547;
126.0264059984401, 132.9362320783237;
130.8489939558713, 132.8378119159272;
135.3763214261129, 131.7551901295651;
140, 130;
142.7578336058546, 127.7199634713063;
146.5962199393203, 124.668938437013;
144.7262368537857, 123.9799973002371;
142.0688924690787, 125.9484005481683;
140.3957497083373, 121.7163335651164;
142.5609932810615, 120.240031129168;
146.1041191273375, 117.6811069068576;
144.1357158794064, 116.1063843085127;
140, 115;
132.7189770414059, 113.2521995990126;
125.829565673647, 113.3506197614091;
117.7591123571294, 116.1063843085127;
111.8539026133361, 116.7953254452886;
115.1017679724224, 122.2084343770991;
118.5464736563018, 124.9641989242027;
121.7943390153882, 126.3420811977545;
126.715347135216, 125.9484005481683;
128.9790108703368, 125.2594594113924;
130.9474141182679, 122.5036948642888;
131.4395149302507, 119.354249667599;
129.4711116823196, 116.8937456076851;
125.3374648616642, 115.9095439837196;
121.6959188529916, 117.582686744461;
119.5306752802674, 121.6179134027198;
123.5659019385262, 126.3420811977545;
123.17222128894, 130.8694086679961;
123.4862062553973, 128.2603969726501;
119.3904749782433, 128.0448321685894;
126.7196783163083, 127.9011222992155;
133.1866224381304, 127.1825729523464;
136.779369172476, 126.3203137361035;
139.6535665599525, 125.9610390626689;
149.0648376336751, 121.9764308531746;
153.0359708181009, 118.9396819474372;
155.7223256193301, 114.8517507281753;
157.9414882812151, 109.9462332650611;
164.248582162362, 109.3622430908808;
167.9861192771157, 119.0564799822733;
164.6055905341297, 131.2367350404626;
160, 130;
151.446033779407, 145.8101284713126;
137.0901536833458, 150.2691518344832;
120, 150;
110, 150;
103.1580734562922, 145.5926151365238;
101.2004534431929, 138.7409450906764;
104.5719101324194, 133.520625055745;
111.74985018045, 133.4118683883506;
120.4503835720022, 138.632188423282;
145.0293904031372, 140.0460250994092;
156.7751104817328, 132.433058381801;
162.9742405232137, 134.4994350622947;
156.4122760997152, 150.2000251211197;
151.6853786023206, 158.5864561648844;
146.8060005404939, 166.3629649509207;
143.4514281229881, 173.2245903503645;
90.3881917006228, 173.2245903503645;
47.425199976227, 173.1290917459594;
42.4434330746339, 167.4601845820776;
38.3205915009017, 159.0427163690409;
61.1680052220009, 158.18379104118;
70.7879688940427, 154.9198747953087;
75.7697357956358, 149.2509676314269;
77.6593715169297, 143.7538455331172;
76.8004461890688, 139.4592188938129;
50.6891162220983, 147.361331910133;
32.8234694025921, 145.471696188839;
29.5595531567208, 148.392042303566;
34.7131051238861, 156.1223702543139;
37.4334741150121, 157.5337086729396;
33.8398572212408, 143.1592410978544;
34.1028047988338, 136.3226040804358;
35.8619719469281, 133.6292184741965;
36.1172015155378, 127.1208644746493;
34.2029797509651, 119.3363626320536;
32.9268319079167, 112.3175494952869;
32.1611432020876, 106.1920398486542;
32.2887579863924, 100.0665302020215;
33.8201353980506, 93.6857909867792;
36.2448162998427, 88.5811996145852;
33.0319376993302, 88.6588273267933;
37.648578927196, 74.671188125357;
42.8807850836946, 61.3992505576528;
45.8159251227061, 55.7842000482395;
53.345197396692, 43.5331807549741;
61.7677731608118, 32.5583093047571;
69.5522750034074, 22.7319709132839;
77.2091620616982, 15.4579282079075;
82.8242125711114, 12.0123290316766;
93.2886248841088, 9.4600333455797;
102.725973001348, 9.9459036354825;
111.9465980728057, 13.9694491212096;
114.628961729957, 20.1724150783721;
116.9760299299644, 28.2195060498262;
122.340757244267, 33.5842333641289;
121.8378140585512, 39.7871993212914;
116.8083822013924, 36.4342447498522;
109.9348253299422, 33.7518810927008;
100.8818479870565, 32.913642449841;
86.967086515584, 33.5842333641289;
78.2494046298423, 35.5960061069924;
72.0464386726798, 39.9548470498634;
67.0170068155211, 45.3195743641661;
79.7582341869899, 46.4931084641698;
86.4641433298682, 43.6430970784465;
92.4994615584586, 42.6372107070147;
97.8641888727613, 45.1519266355941;
111.2760071585178, 42.8048584355867;
122.0054617871231, 42.1342675212988;
116.8083822013924, 44.6489834498782;
107.5877571299348, 47.3313471070296;
96.5230070441856, 51.6901880499006;
90, 50;
84.6200183155766, 50.6843016784688;
78.2494046298423, 53.7019607927641;
65.5081772583735, 46.4930841016792;
73.1784323685224, 45.7386327793695;
80.8513424888262, 45.9649751466212;
84.5607041331437, 44.0361070915761;
89.5312487365292, 42.9974858311672;
95.6887890660963, 44.1844815573488;
102.0688910943224, 44.3328560231215;
107.7071207936851, 43.2942347627126;
114.1614100547976, 41.9588645707582;
124.4571826484136, 39.0243227938553;
130.588642313308, 42.494960340022;
135.2161590415301, 46.659725395422;
136.9514778146134, 54.5265038333999;
138.108356996669, 60.8893393347055;
140, 70;
143.5979038934248, 80.457346033121;
150, 90;
155.7732561903532, 95.4270414801643;
160, 100;
163.002981963644, 102.7323018595267;
165.2683171270717, 106.325592118757;
165.3464321327072, 104.0602569553292;
158.1598516142467, 103.669681927152;
157.0662415353505, 99.9201616566509;
155.1133663944646, 96.9517914425041;
152.8480312310368, 93.4366161889093;
148.1611308929105, 87.1093007324386;
145.8952731182683, 83.1586981117362;
140.1772915959575, 79.1622594133469;
133.1972443495751, 77.9414995779256;
123.520590491463, 79.0874191137546;
115.1171805620498, 82.1432045426322;
106.9684194183764, 88.8913973647368;
100.092902203402, 101.8784854374664;
97.8010631317439, 114.3562759387164;
98.5650094889632, 107.2261099380021;
102.7667144536698, 94.4936706510123;
110.2788536329937, 85.5809631501194;
111.2974487759529, 79.9786898638439;
111.8067463474325, 73.8671190060888;
110, 70;
103.5306608108892, 66.7369530053745;
103.2760120251494, 71.193306755821;
100.3475509891418, 74.1217677918286;
96.9097923816546, 73.3578214346092;
93.3447093812975, 71.3206311486909;
92.708087416948, 68.5194945055531;
88.6337068451113, 66.3549798267648;
82.904109165966, 67.2462505768541;
80, 70;
77.1745114868206, 73.612470220349;
74.8826724151625, 75.7769848991373;
74.7553480222926, 73.1031726488694;
71.0629406290656, 73.8671190060888;
68.007155200188, 77.0502288278363;
67.7525064144483, 81.5065825782827;
71.0629406290656, 86.4722339002087;
74.1187260579431, 91.183236436395;
77.0471870939507, 95.5122657939715;
78.4477554155196, 99.5866463658083;
79.211701772739, 104.1703245091246;
78.1931066297798, 108.3720294738312;
76.4105651296012, 112.7010588314078;
75.2646455937721, 116.6481150103746;
76.2832407367313, 109.5179490096603;
76.1559163438614, 103.1517293661654;
74.246050450813, 97.8041048656297;
71.0629406290656, 91.9471827936144;
66.2711986077133, 87.5498442811134;
59.1970267544911, 84.6369499886101;
49.2099606087657, 83.5966305984304;
39.380459729207, 86.0950011224199;
28.1484592148096, 91.3447404932797;
22.6545459197239, 96.7165668262524;
18.6256761699944, 101.9663061971122;
14.8409803444909, 109.1694369617802;
12.7655019885696, 114.4191763326399
];


%% Pure pursuit controller
controller = controllerPurePursuit;
controller.Waypoints = waypoints;
controller.LookaheadDistance = 0.5;
controller.DesiredLinearVelocity = 1;
controller.MaxAngularVelocity = 1.5;



%Create vizualizaer
viz = Visualizer2D;
viz.hasWaypoints = true ;


%% Simulation loop
close all 
r = rateControl(1/sampleTime);
for idx = 2:numel(tVec)
    %comentario
    [vRef, wRef] = controller(pose(:,idx-1));
    [wL, wR] = inverseKinematics(dd, vRef, wRef);

    %Compute the velocities
    [v,w] = forwardKinematics(dd,wL,wR);
    velB = [v;0;w];
    vel = bodyToWorld(velB,pose(:, idx-1));

    %si
    pose(:,idx) = pose(:,idx-1) + vel*sampleTime;

    %upgrade
    viz(pose(:,idx), waypoints);
    waitfor(r);
end

plot(pose(1,:), pose(2,:), "Color","#7E2F8E", "LineWidth",3)
title("Trayectoria con waypoints")